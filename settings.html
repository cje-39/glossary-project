<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - East translation team Glossary</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .settings-section h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #333;
            border-bottom: 2px solid #0d4a1f;
            padding-bottom: 10px;
        }
        .settings-section h3 {
            margin: 20px 0 10px 0;
            font-size: 16px;
            color: #555;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0d4a1f;
            box-shadow: 0 0 0 2px rgba(13, 74, 31, 0.1);
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }
        .page-url-list {
            margin-top: 15px;
        }
        .page-url-item {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .page-url-item input {
            flex: 1;
        }
        .page-url-item button {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-add-page {
            margin-top: 10px;
        }
        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .last-check-info {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-family: 'KraftonFont', 'Pretendard', 'Nanum Gothic', 나눔고딕, sans-serif;">Settings</h1>
                <div style="display: flex; gap: 15px;">
                    <a href="index.html" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 8px 16px; font-size: 13px;">← Glossary로 돌아가기</a>
                </div>
            </div>
        </header>

        <div class="settings-container">
            <!-- Confluence API 설정 -->
            <div class="settings-section">
                <h2>Confluence API 설정</h2>
                
                <div class="form-group">
                    <label for="apiToken">API Token *</label>
                    <input type="password" id="apiToken" placeholder="Confluence API Token을 입력하세요">
                    <small>
                        Atlassian 계정 설정에서 API Token을 생성할 수 있습니다.<br>
                        <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">API Token 생성하기</a>
                    </small>
                </div>

                <div id="apiTokenStatus" class="status-message" style="display: none;"></div>
            </div>

            <!-- 모니터링 페이지 설정 -->
            <div class="settings-section">
                <h2>모니터링 페이지</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    새 용어를 자동으로 감지할 Confluence 페이지 URL을 추가하세요.
                </p>

                <div id="pageUrlList" class="page-url-list">
                    <!-- 페이지 URL 목록이 여기에 동적으로 추가됩니다 -->
                </div>

                <button type="button" id="addPageUrlBtn" class="btn btn-secondary btn-add-page">+ 페이지 추가</button>

                <div id="pageUrlStatus" class="status-message" style="display: none;"></div>
            </div>

            <!-- 체크 주기 설정 -->
            <div class="settings-section">
                <h2>자동 체크 설정</h2>
                
                <div class="form-group">
                    <label for="checkInterval">체크 주기</label>
                    <select id="checkInterval">
                        <option value="1800000">30분마다</option>
                        <option value="3600000" selected>1시간마다</option>
                        <option value="7200000">2시간마다</option>
                        <option value="14400000">4시간마다</option>
                        <option value="86400000">1일마다</option>
                    </select>
                    <small>설정한 주기마다 Confluence 페이지를 자동으로 체크합니다.</small>
                </div>

                <div class="test-section">
                    <button type="button" id="testConnectionBtn" class="btn btn-secondary">연결 테스트</button>
                    <button type="button" id="manualRefreshBtn" class="btn btn-primary">지금 새로고침</button>
                    
                    <div id="testStatus" class="status-message" style="display: none;"></div>
                    
                    <div id="lastCheckInfo" class="last-check-info" style="display: none;">
                        <strong>마지막 체크 시간:</strong> <span id="lastCheckTime"></span>
                    </div>
                </div>
            </div>

            <!-- 저장 버튼 -->
            <div style="text-align: right; margin-top: 30px;">
                <button type="button" id="saveSettingsBtn" class="btn btn-primary" style="padding: 12px 24px; font-size: 14px;">설정 저장</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v8 (CDN 호환) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="firebase-init.js"></script>
    <script src="auth.js"></script>
    <script src="netlify-config.js"></script>
    <script src="confluence-integration.js"></script>
    <script>
        // 설정 페이지 초기화
        (async function() {
            await waitForFirebaseSDK();
            
            // Confluence 통합 초기화 대기
            if (window.confluenceIntegration && !window.confluenceIntegration.initialized) {
                await window.confluenceIntegration.initialize();
            }
            
            const settingsPage = {
                async init() {
                    await this.loadSettings();
                    this.setupEventListeners();
                },

                async loadSettings() {
                    if (window.confluenceIntegration) {
                        if (!window.confluenceIntegration.initialized) {
                            await window.confluenceIntegration.initialize();
                        }
                        
                        // API Token 표시 (마스킹)
                        const tokenInput = document.getElementById('apiToken');
                        if (tokenInput && window.confluenceIntegration.apiToken) {
                            tokenInput.value = '••••••••••••••••';
                            tokenInput.setAttribute('data-token', window.confluenceIntegration.apiToken);
                        }

                        // 페이지 URL 목록 표시
                        this.renderPageUrlList();

                        // 체크 주기 설정
                        const intervalSelect = document.getElementById('checkInterval');
                        if (intervalSelect) {
                            intervalSelect.value = window.confluenceIntegration.checkInterval;
                        }

                        // 마지막 체크 시간 표시
                        if (window.confluenceIntegration.lastCheckTime) {
                            const lastCheckInfo = document.getElementById('lastCheckInfo');
                            const lastCheckTime = document.getElementById('lastCheckTime');
                            if (lastCheckInfo && lastCheckTime) {
                                lastCheckTime.textContent = new Date(window.confluenceIntegration.lastCheckTime).toLocaleString('ko-KR');
                                lastCheckInfo.style.display = 'block';
                            }
                        }
                    }
                },

                renderPageUrlList() {
                    const list = document.getElementById('pageUrlList');
                    if (!list) return;

                    const pages = window.confluenceIntegration.monitoredPages || [];
                    
                    if (pages.length === 0) {
                        list.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px;">등록된 페이지가 없습니다.</p>';
                        return;
                    }

                    list.innerHTML = pages.map((url, index) => `
                        <div class="page-url-item">
                            <input type="text" class="page-url-input" value="${this.escapeHtml(url)}" data-index="${index}" placeholder="https://krafton.atlassian.net/wiki/...">
                            <button type="button" class="btn btn-danger remove-page-btn" data-index="${index}">삭제</button>
                        </div>
                    `).join('');

                    // 삭제 버튼 이벤트
                    list.querySelectorAll('.remove-page-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const index = parseInt(btn.getAttribute('data-index'));
                            this.removePageUrl(index);
                        });
                    });

                    // URL 입력 변경 이벤트
                    list.querySelectorAll('.page-url-input').forEach(input => {
                        input.addEventListener('change', () => {
                            const index = parseInt(input.getAttribute('data-index'));
                            window.confluenceIntegration.monitoredPages[index] = input.value.trim();
                        });
                    });
                },

                removePageUrl(index) {
                    window.confluenceIntegration.monitoredPages.splice(index, 1);
                    this.renderPageUrlList();
                },

                setupEventListeners() {
                    // 페이지 추가 버튼
                    const addBtn = document.getElementById('addPageUrlBtn');
                    if (addBtn) {
                        addBtn.addEventListener('click', () => {
                            if (!window.confluenceIntegration.monitoredPages) {
                                window.confluenceIntegration.monitoredPages = [];
                            }
                            window.confluenceIntegration.monitoredPages.push('');
                            this.renderPageUrlList();
                        });
                    }

                    // API Token 표시/숨김 토글
                    const tokenInput = document.getElementById('apiToken');
                    if (tokenInput) {
                        tokenInput.addEventListener('focus', () => {
                            if (tokenInput.value === '••••••••••••••••' && tokenInput.getAttribute('data-token')) {
                                tokenInput.value = tokenInput.getAttribute('data-token');
                            }
                        });
                        tokenInput.addEventListener('blur', () => {
                            if (tokenInput.value && tokenInput.value !== '••••••••••••••••') {
                                tokenInput.setAttribute('data-token', tokenInput.value);
                            }
                        });
                    }

                    // 연결 테스트 버튼
                    const testBtn = document.getElementById('testConnectionBtn');
                    if (testBtn) {
                        testBtn.addEventListener('click', async () => {
                            await this.testConnection();
                        });
                    }

                    // 수동 새로고침 버튼
                    const refreshBtn = document.getElementById('manualRefreshBtn');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', async () => {
                            await this.manualRefresh();
                        });
                    }

                    // 설정 저장 버튼
                    const saveBtn = document.getElementById('saveSettingsBtn');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', async () => {
                            await this.saveSettings();
                        });
                    }
                },

                async testConnection() {
                    const statusDiv = document.getElementById('testStatus');
                    if (!statusDiv) return;

                    const tokenInput = document.getElementById('apiToken');
                    const token = tokenInput.value.trim();
                    
                    if (!token || token === '••••••••••••••••') {
                        this.showStatus('testStatus', 'error', 'API Token을 입력해주세요.');
                        return;
                    }

                    this.showStatus('testStatus', 'info', '연결 테스트 중...');

                    try {
                        // 첫 번째 페이지로 테스트
                        const pages = window.confluenceIntegration.monitoredPages || [];
                        if (pages.length === 0 || !pages[0]) {
                            throw new Error('테스트할 페이지 URL을 먼저 추가해주세요.');
                        }

                        const testToken = tokenInput.getAttribute('data-token') || token;
                        const originalToken = window.confluenceIntegration.apiToken;
                        window.confluenceIntegration.apiToken = testToken;

                        const result = await window.confluenceIntegration.checkPage(pages[0]);
                        
                        // 원래 토큰 복원
                        window.confluenceIntegration.apiToken = originalToken;
                        
                        this.showStatus('testStatus', 'success', 
                            `연결 성공! 페이지에서 ${result.extractedTerms.length}개의 용어를 찾았습니다.`);
                    } catch (error) {
                        // 원래 토큰 복원
                        if (window.confluenceIntegration) {
                            const originalToken = document.getElementById('apiToken')?.getAttribute('data-token');
                            if (originalToken) {
                                window.confluenceIntegration.apiToken = originalToken;
                            }
                        }
                        
                        // 에러 메시지 개선
                        let errorMessage = error.message || '알 수 없는 오류가 발생했습니다.';
                        
                        // CORS 에러인 경우
                        if (errorMessage.includes('CORS') || errorMessage.includes('cors')) {
                            errorMessage = 'CORS 오류: 브라우저에서 직접 Confluence API를 호출할 수 없습니다. Firebase Functions를 통해 호출하도록 수정이 필요합니다.';
                        }
                        // 네트워크 에러인 경우
                        else if (errorMessage.includes('fetch') || errorMessage.includes('network')) {
                            errorMessage = '네트워크 오류: Confluence API에 연결할 수 없습니다. 인터넷 연결과 API Token을 확인해주세요.';
                        }
                        // 인증 에러인 경우
                        else if (errorMessage.includes('401') || errorMessage.includes('인증')) {
                            errorMessage = '인증 실패: API Token이 올바르지 않거나 만료되었습니다. Atlassian에서 새로운 API Token을 생성해주세요.';
                        }
                        // 페이지를 찾을 수 없는 경우
                        else if (errorMessage.includes('404') || errorMessage.includes('찾을 수 없')) {
                            errorMessage = '페이지를 찾을 수 없습니다: URL이 올바른지 확인해주세요.';
                        }
                        
                        console.error('연결 테스트 실패:', error);
                        this.showStatus('testStatus', 'error', `연결 실패: ${errorMessage}`);
                    }
                },

                async manualRefresh() {
                    const statusDiv = document.getElementById('testStatus');
                    if (!statusDiv) return;

                    this.showStatus('testStatus', 'info', '페이지를 체크하는 중...');

                    try {
                        const results = await window.confluenceIntegration.manualRefresh();
                        let totalNew = 0;
                        results.forEach(r => {
                            if (r.newTerms) {
                                totalNew += r.newTerms.length;
                            }
                        });

                        if (totalNew > 0) {
                            this.showStatus('testStatus', 'success', 
                                `${totalNew}개의 새로운 용어가 감지되었습니다! 알림을 확인해주세요.`);
                        } else {
                            this.showStatus('testStatus', 'info', '새로운 용어가 없습니다.');
                        }

                        // 마지막 체크 시간 업데이트
                        const lastCheckInfo = document.getElementById('lastCheckInfo');
                        const lastCheckTime = document.getElementById('lastCheckTime');
                        if (lastCheckInfo && lastCheckTime) {
                            lastCheckTime.textContent = new Date().toLocaleString('ko-KR');
                            lastCheckInfo.style.display = 'block';
                        }
                    } catch (error) {
                        this.showStatus('testStatus', 'error', `체크 실패: ${error.message}`);
                    }
                },

                async saveSettings() {
                    const tokenInput = document.getElementById('apiToken');
                    const intervalSelect = document.getElementById('checkInterval');
                    
                    if (tokenInput) {
                        const token = tokenInput.value.trim();
                        if (token && token !== '••••••••••••••••') {
                            window.confluenceIntegration.apiToken = token;
                        } else if (tokenInput.getAttribute('data-token')) {
                            window.confluenceIntegration.apiToken = tokenInput.getAttribute('data-token');
                        }
                    }

                    if (intervalSelect) {
                        window.confluenceIntegration.checkInterval = parseInt(intervalSelect.value);
                    }

                    // 페이지 URL 업데이트
                    const urlInputs = document.querySelectorAll('.page-url-input');
                    urlInputs.forEach(input => {
                        const index = parseInt(input.getAttribute('data-index'));
                        window.confluenceIntegration.monitoredPages[index] = input.value.trim();
                    });
                    window.confluenceIntegration.monitoredPages = window.confluenceIntegration.monitoredPages.filter(url => url.trim() !== '');

                    try {
                        await window.confluenceIntegration.saveSettings();
                        
                        // 주기적 체크 재시작
                        window.confluenceIntegration.stopPeriodicCheck();
                        if (window.confluenceIntegration.apiToken && window.confluenceIntegration.monitoredPages.length > 0) {
                            window.confluenceIntegration.startPeriodicCheck();
                        }

                        alert('설정이 저장되었습니다.');
                    } catch (error) {
                        alert('설정 저장에 실패했습니다: ' + error.message);
                    }
                },

                showStatus(elementId, type, message) {
                    const statusDiv = document.getElementById(elementId);
                    if (statusDiv) {
                        statusDiv.className = `status-message ${type}`;
                        statusDiv.textContent = message;
                        statusDiv.style.display = 'block';
                    }
                },

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };

            // 페이지 로드 후 초기화
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    settingsPage.init();
                });
            } else {
                settingsPage.init();
            }
        })();
    </script>
</body>
</html>
